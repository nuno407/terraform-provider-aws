apiVersion: skaffold/v4beta2
kind: Config
metadata:
  name: container-scripts
manifests:
  kustomize:
    paths:
      # this includes all locally available services
      - ../../kubernetes_config/apps/pg/selector
      - ../../kubernetes_config/apps/pg/mdfparser
      - ../../kubernetes_config/apps/pg/sdm
      - ../../kubernetes_config/apps/pg/voxel-stack
      - ../../kubernetes_config/apps/pg/data_importer
      - ../../kubernetes_config/apps/pg/labeling_bridge
      - ../../kubernetes_config/apps/pg/jupyter-server
      - ../../kubernetes_config/apps/pg/metadata
    buildArgs:
      - "--load-restrictor=LoadRestrictionsNone"
build:
    local:
      push: false
      concurrency: 3
      useBuildkit: true
    artifacts:
      # SDM
    - image: 081962623310.dkr.ecr.eu-central-1.amazonaws.com/sdm
      context: ..
      docker:
        dockerfile: SDM/Dockerfile
      runtimeType: python
      # Selector
    - image: 081962623310.dkr.ecr.eu-central-1.amazonaws.com/selector
      context: ..
      docker:
        dockerfile: Selector/Dockerfile
      runtimeType: python
      # MDFParser
    - image: 081962623310.dkr.ecr.eu-central-1.amazonaws.com/mdfparser
      context: ..
      docker:
        dockerfile: MDFParser/Dockerfile
      runtimeType: python
      # Data importer
    - image: 081962623310.dkr.ecr.eu-central-1.amazonaws.com/data_importer
      context: ..
      docker:
        dockerfile: data_importer/Dockerfile
        buildArgs:
          LOCALSTACK_PATCH: "true"
        secrets:
          - id: voxel51token
            env: VOXEL_REGISTRY_TOKEN
      runtimeType: python
      # Labeling Bridge
    - image: 081962623310.dkr.ecr.eu-central-1.amazonaws.com/labeling_bridge
      context: ..
      docker:
        dockerfile: labeling_bridge/Dockerfile
        buildArgs:
          LOCALSTACK_PATCH: "true"
        secrets:
          - id: voxel51token
            env: VOXEL_REGISTRY_TOKEN
      runtimeType: python
      # Local Voxel Instance
    - image: voxel-local
      context: ../../kubernetes_config/apps/pg/voxel-stack/image
      docker:
        dockerfile: Dockerfile
        secrets:
          - id: voxel51token
            env: VOXEL_REGISTRY_TOKEN
      runtimeType: python
    - image: voxel-ui-plugins-image
      context: ../../voxel51_plugins/ui-plugins
      docker:
        dockerfile: ../utils/ui-plugins/Dockerfile.BuildPlugins
    # Local jupyter server
    - image: jupyter-server-local
      context: ../../kubernetes_config/apps/pg/jupyter-server/image
      docker:
        dockerfile: Dockerfile
        secrets:
          - id: voxel51token
            env: VOXEL_REGISTRY_TOKEN
    - image: 081962623310.dkr.ecr.eu-central-1.amazonaws.com/metadata
      context: ..
      docker:
        dockerfile: Metadata/Dockerfile
        buildArgs:
          LOCALSTACK_PATCH: "true"
        secrets:
          - id: voxel51token
            env: VOXEL_REGISTRY_TOKEN
      runtimeType: python
deploy:
  # Set this value according to your needs. Very dangerous since you can destroy the full deployment of an application if you point to the wrong context (aka wrong)
  kubeContext: kind-kind


profiles:
- name: local
  activation:
    - kubeContext: kind-kind

portForward:
  - resourceType: Service
    resourceName: voxel
    namespace: data-ingestion
    port: 5151
    localPort: 5151
  - resourceType: Service
    resourceName: labeling-bridge
    namespace: data-ingestion
    port: 80
    localPort: 5000
  - resourceType: Service
    resourceName: mongodb
    namespace: data-ingestion
    port: 27017
    localPort: 27017
  - resourceType: Service
    resourceName: jupyter-server
    namespace: data-ingestion
    port: 8888
    localPort: 8888
