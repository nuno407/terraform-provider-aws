name: PR Pipeline

on:
  pull_request:
    types: [opened, synchronize, reopened]
    branches:
      - master

env:
  AWS_DEFAULT_REGION: eu-central-1
  AWS_ROLE: arn:aws:iam::081962623310:role/github-oidc-access
permissions:
  id-token: write   # This is required for requesting the JWT
  contents: read    # This is required for actions/checkout
jobs:
  pre-commit:
    name: Pre-commit checks
    runs-on: ubuntu-22.04
    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Pre-commit check
      uses: pre-commit/action@v3.0.0

    - name: Check pull request title
      env:
        PR_TITLE: ${{ github.event.pull_request.title }}
      run: |
        REGEX_PR_TITLE='MC-[0-9]{4,}|NO-TICKET|Bump'
        [[ $PR_TITLE =~ $REGEX_PR_TITLE ]] && exit 0
        echo "The pull request title does not contain a ticket name." 1>&2
        exit 1

  login-to-amazon-ecr:
    # https://github.com/aws-actions/amazon-ecr-login#docker-credentials
    name: Login to Amazon ECR
    runs-on: ubuntu-latest
    steps:
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ env.AWS_ROLE }}
          aws-region: ${{ env.AWS_DEFAULT_REGION }}
      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2
        with:
          mask-password: 'false' # https://github.com/actions/runner/issues/1498#issuecomment-1066836352
    outputs:
      registry: ${{ steps.login-ecr.outputs.registry }}
      docker_username: ${{ steps.login-ecr.outputs.docker_username_081962623310_dkr_ecr_eu_central_1_amazonaws_com }}
      docker_password: ${{ steps.login-ecr.outputs.docker_password_081962623310_dkr_ecr_eu_central_1_amazonaws_com }}


  determine-changed-services:
    name: Determine which services to build
    runs-on: ubuntu-22.04
    outputs:
      services: ${{ steps.changed-services.outputs.services }}
      needs-testing: ${{ steps.changed-services.outputs.needs-testing }}
      python-directories: ${{ steps.changed-services.outputs.python-directories }}
      javascript-directories: ${{ steps.changed-services.outputs.javascript-directories }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
      - name: Determine services to build
        id: changed-services
        uses: bosch-rc-dev/actions/determine-services-to-build@main
        with:
          services: ${{ inputs.services }}

  lint-python-projects:
    name: Lint Python
    runs-on: ubuntu-22.04
    needs: [determine-changed-services]
    strategy:
      fail-fast: false
      matrix:
        python-version: ["3.10"]
        service: ${{ fromJSON(needs.determine-changed-services.outputs.python-directories) }}

    steps:
      - name: Checkout code
        if: ${{contains(fromJSON(needs.determine-changed-services.outputs.needs-testing), matrix.service)}}
        uses: actions/checkout@v3
      - uses: bosch-rc-dev/actions/lint-python@main
        if: ${{contains(fromJSON(needs.determine-changed-services.outputs.needs-testing), matrix.service)}}
        with:
          baseDir: ${{ matrix.service }}
          python-version: ${{ matrix.python-version }}
          voxel-pip-registry-token: ${{ secrets.FIFTYONE_TOKEN }}

  lint-javascript-projects:
    name: Lint Javascript
    runs-on: ubuntu-22.04
    needs: [determine-changed-services]
    strategy:
      fail-fast: false
      matrix:
        node-version: ["18.x"]
        service: ${{ fromJSON(needs.determine-changed-services.outputs.javascript-directories) }}
    steps:
      - name: Checkout code
        if: ${{contains(fromJSON(needs.determine-changed-services.outputs.needs-testing), matrix.service)}}
        uses: actions/checkout@v3
      - uses: bosch-rc-dev/actions/lint-javascript@main
        if: ${{contains(fromJSON(needs.determine-changed-services.outputs.needs-testing), matrix.service)}}
        with:
          baseDir: ${{ matrix.service }}
          node-version: ${{ matrix.node-version }}
          npm-registry: https://artifactory.boschdevcloud.com/artifactory/api/npm/lab000003-bci-npm-virtual/
          npm-auth: ${{ secrets.NPM_AUTH }}
          npm-email: ${{ secrets.NPM_EMAIL }}

  run-python-sast:
    name: SAST Python
    runs-on: ubuntu-22.04
    if: success() || failure() # making SAST optional for now
    needs: [determine-changed-services]
    strategy:
      fail-fast: false
      matrix:
        python-version: ["3.10"]
        service: ${{ fromJSON(needs.determine-changed-services.outputs.python-directories) }}

    steps:
      - name: Checkout code
        if: ${{contains(fromJSON(needs.determine-changed-services.outputs.needs-testing), matrix.service)}}
        uses: actions/checkout@v3
      - uses: bosch-rc-dev/actions/sast-python@main
        if: ${{contains(fromJSON(needs.determine-changed-services.outputs.needs-testing), matrix.service)}}
        with:
          baseDir: ${{ matrix.service }}
          python-version: ${{ matrix.python-version }}

  run-python-tests:
    name: Unit tests
    runs-on: ubuntu-22.04
    if: success() || failure() # making lint optional for now
    needs: [determine-changed-services]
    strategy:
      fail-fast: false
      matrix:
        python-version: ["3.10"]
        service: ${{ fromJSON(needs.determine-changed-services.outputs.python-directories) }}

    steps:
      - name: Checkout code
        if: ${{contains(fromJSON(needs.determine-changed-services.outputs.needs-testing), matrix.service)}}
        uses: actions/checkout@v3
      - uses: bosch-rc-dev/actions/test-python@main
        if: ${{contains(fromJSON(needs.determine-changed-services.outputs.needs-testing), matrix.service)}}
        name: Run unit tests
        with:
          baseDir: ${{ matrix.service }}
          python-version: ${{ matrix.python-version }}
          voxel-pip-registry-token: ${{ secrets.FIFTYONE_TOKEN }}

  run-python-integration-tests:
    name: Integration tests
    needs: [determine-changed-services, login-to-amazon-ecr]
    runs-on: ubuntu-22.04
    services:
      mongo:
        image: ${{ needs.login-to-amazon-ecr.outputs.registry }}/base-images:mongo5.0
        credentials:
          username: ${{ needs.login-to-amazon-ecr.outputs.docker_username }}
          password: ${{ needs.login-to-amazon-ecr.outputs.docker_password }}
        ports:
          - 27017:27017
    if: success() || failure() # making lint optional for now
    strategy:
      fail-fast: false
      matrix:
        python-version: ["3.10"]
        service: ${{ fromJSON(needs.determine-changed-services.outputs.python-directories) }}

    steps:
      - name: Checkout code
        if: ${{contains(fromJSON(needs.determine-changed-services.outputs.needs-testing), matrix.service)}}
        uses: actions/checkout@v3
      - name: Run integration tests
        if: ${{contains(fromJSON(needs.determine-changed-services.outputs.needs-testing), matrix.service)}}
        uses: bosch-rc-dev/actions/test-python@main
        with:
          baseDir: ${{ matrix.service }}
          python-version: ${{ matrix.python-version }}
          voxel-pip-registry-token: ${{ secrets.FIFTYONE_TOKEN }}
          extra-pytest-args: -m integration
          mode: integration

  run-javascript-tests:
    name: Javascript tests
    runs-on: ubuntu-22.04
    if: success() || failure() # making lint optional for now
    needs: [determine-changed-services]
    strategy:
      fail-fast: false
      matrix:
        node-version: ["18.x"]
        service: ${{ fromJSON(needs.determine-changed-services.outputs.javascript-directories) }}

    steps:
      - name: Checkout code
        if: ${{contains(fromJSON(needs.determine-changed-services.outputs.needs-testing), matrix.service)}}
        uses: actions/checkout@v3
      - uses: bosch-rc-dev/actions/test-javascript@main
        if: ${{contains(fromJSON(needs.determine-changed-services.outputs.needs-testing), matrix.service)}}
        with:
          baseDir: ${{ matrix.service }}
          node-version: ${{ matrix.node-version }}
          npm-registry: https://artifactory.boschdevcloud.com/artifactory/api/npm/lab000003-bci-npm-virtual/
          npm-auth: ${{ secrets.NPM_AUTH }}
          npm-email: ${{ secrets.NPM_EMAIL }}


  sonarqube-scan:
    name: Sonarqube scan on code
    runs-on: ubuntu-22.04
    needs: [run-python-tests, run-python-integration-tests, run-javascript-tests, run-python-sast]
    if: success() || failure()
    steps:
      - name: Checkout source
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Get static analysis and coverage reports
        uses: actions/download-artifact@v3

      - name: Collect SAST reports
        id: sast-reports
        run: |
          echo "report-paths=$(ls --format=commas *-security-report/*.json | tr -s '[:blank:]' ',' | tr -d '\n')" >> $GITHUB_OUTPUT

      - name: Sonarqube scan
        id: sonarqube-scan
        uses: bosch-rc-dev/actions/scan-code@main
        timeout-minutes: 5
        with:
          baseDir: "./"
          url: ${{ secrets.SONAR_HOST_URL }}
          token: ${{ secrets.SONAR_TOKEN }}
          args:  >
            -Dsonar.pullrequest.key=${{ github.event.number }}
            -Dsonar.pullrequest.branch=${{ github.head_ref }}
            -Dsonar.pullrequest.base=master
            -Dsonar.python.bandit.reportPaths=${{ steps.sast-reports.outputs.report-paths }}

      - name: Sonarqube quality gate status
        run: "echo quality gate result: ${{steps.sonarqube-scan.outputs.scan-success}}"

      - name: Check python unit test matrix status
        if: ${{ needs.run-python-tests.result != 'success' }}
        run: exit 1
